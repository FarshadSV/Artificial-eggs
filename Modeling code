#Upload packages 
library(ggplot2)
library(ggeffects)
library(effects)
library(lme4)
library(lmerTest)
library(glmmTMB)
library(emmeans)
library(Matrix)
library(lmerTest)
library(dplyr)
library(writexl)
library(DHARMa)
library(performance)
library(car)
library(Hmisc)
library(MASS)
library(betareg)
library(lmtest)
library(MuMIn)
library(rptR)
library(boot)
#R.version.string
#citation()
#Upload datasets 
ED1 <- ED1_FINAL
ED2 <- ED2_FINAL
GD1 <- GD1_FINAL
GD2 <- GD2_FINAL

#Data exploration 
#Making the weighted average for the egg attendance for the nests with 2 loggers 
#Weighted average egg turning rate= (Egg turning all*recorded hours)1 + (Egg turning all* recorded hours)2 / Recorded hours 1+ Recorded hours 2
#1) K26 (Overall turns divided by overall recorded hours)
eggTurn1 <- 33/668
eggTurn2 <- 48/75
AVG_egg_turns_weighted1 <- (eggTurn1 * 668 + eggTurn2 * 75) / (668 + 75)
GD1$AVG_turns_hour[13] <- 0.109

eggTemp1 <- 41.98
eggTemp2 <- 37.50
AVG_egg_Temp_weighted1 <- (eggTemp1 * 668 + eggTemp2 * 75) / (668 + 75)
GD1$AVG_Temp_egg_Hour[13] <- 41.527
#AND NIGHT AND DAY TURNS 
Euler_day1 <- 0.052
Euler_night1 <- 0.041
Euler_day2 <- 0.741
Euler_night2 <- 0.277
Day_turn_weighted <- (Euler_day1 * 668 + Euler_day2 * 75) / (668 + 75)
Night_turn_weighted <- (Euler_night1 * 668 + Euler_night2 * 75) / (668 + 75)
GD1$Day_turns[13]<- 0.121
GD1$Night_turns[13]<- 0.064

# K22
eggTurn1 <- 771/567
eggTurn2 <- 103/85
AVG_egg_turns_weighted1 <- (eggTurn1 * 567 + eggTurn2 * 85) / (567 + 85)
GD1$AVG_turns_hour[12] <- 1.340

eggTemp1 <- 39.865
eggTemp2 <- 41.526
AVG_egg_Temp_weighted1 <- (eggTemp1 * 567 + eggTemp2 * 85) / (567 + 85)
GD1$AVG_Temp_egg_Hour[12] <- 40.081
#AND NIGHT AND DAY TURNS 
Euler_day1 <- 1.410
Euler_night1 <- 1.215
Euler_day2 <- 1.440
Euler_night2 <- 0.625
Day_turn_weighted <- (Euler_day1 * 567 + Euler_day2 * 85) / (567 + 85)
Night_turn_weighted <- (Euler_night1 * 567 + Euler_night2 * 85) / (567 + 85)
GD1$Day_turns[12]<- 1.413
GD1$Night_turns[12]<- 1.138

# K23
eggTurn1 <- 49/80
eggTurn2 <- 50/78
AVG_egg_turns_weighted1 <- (eggTurn1 * 80 + eggTurn2 * 78) / (80 + 78)
GD1$AVG_turns_hour[11] <- 0.626

eggTemp1 <- 40.911
eggTemp2 <- 40.974
AVG_egg_Temp_weighted1 <- (eggTemp1 * 80 + eggTemp2 * 78) / (80 + 78)
GD1$AVG_Temp_egg_Hour[11] <- 40.942
#AND NIGHT AND DAY TURNS 
Euler_day1 <- 0.716
Euler_night1 <- 0.265
Euler_day2 <- 0.726
Euler_night2 <- 0.333
Day_turn_weighted <- (Euler_day1 * 80 + Euler_day2 * 78) / (80 + 78)
Night_turn_weighted <- (Euler_night1 * 80 + Euler_night2 * 78) / (80 + 78)
GD1$Day_turns[11]<- 0.720
GD1$Night_turns[11]<- 0.298
#
# Creating Body condition: 

#1) For goldeneye 
GD1$log.Weight <- log(GD1$Weight)
GD1$log.Wing <- log(GD1$Wing)
GD_BC <- lm(log.Weight ~ log.Wing, data=GD1)
GD1$BodyCondition <- round(rstandard(GD_BC),2)
#

# 1.1) For eider
#ED1$Wing <- as.numeric(ED1$Wing)
ED1$log.Weight <- log(ED1$Weight)
ED1$log.Wing <- log(ED1$Wing)
ED_BC <- lm(log.Weight ~ log.Wing, data=ED1, na.action = na.exclude)
ED1$BodyCondition <- round(rstandard(ED_BC),2)

## 2) Species data summary

#
#-----Goldeneye vs. eider egg attendance -----

Shapiro <- shapiro.test(GD1$AVG_turns_hour)
Shapiro
Shapiro <- shapiro.test(ED1$AVG_turns_hour)
Shapiro
#Histogram 
hist(ED1$AVG_Temp_egg_Hour)
hist(GD1$AVG_Temp_egg_Hour)
#qq plot
qqnorm(ED1$AVG_Temp_egg_Hour)
qqline(ED1$AVG_Temp_egg_Hour)
qqnorm(GD1$AVG_Temp_egg_Hour)
qqline(GD1$AVG_Temp_egg_Hour)
#2.1) Average turning rate 
mean(GD1$AVG_turns_hour, na.rm=TRUE)
mean(ED1$AVG_turns_hour, na.rm=TRUE)
#) Average hourly turns

var.test(GD1$AVG_turns_hour, ED1$AVG_turns_hour)

T_test <- t.test(na.omit(GD1$AVG_turns_hour), na.omit(ED1$AVG_turns_hour), var.equal = FALSE)
T_test
# Plot 
boxplot(GD1$AVG_turns_hour,ED1$AVG_turns_hour,
        names=c("Goldeneye", "Eider"),
        main=NA, 
        ylab =  expression(plain("Turning frequency (") * h^-1 * plain(")")),
        col=c("gold", "cornflowerblue"),
        border="black",
        notch = FALSE,
        varwidth = TRUE,
        frame.plot=FALSE,
        outline=TRUE,
        axes=TRUE)
jitter <- 0.2
points(jitter(rep(1,length(GD1$AVG_turns_hour)), amount = jitter), GD1$AVG_turns_hour, pch=16, col="black", cex=0.8)
points(jitter(rep(2,length(ED1$AVG_turns_hour)), amount = jitter), ED1$AVG_turns_hour, pch=17, col="black", cex=0.8)

#2.2) Average egg temperature 
GD1 <- GD1%>%
  rename(AVG_Temp_out_Day = `AVG.Temp.out (Day)`,
         DeltaTemp_eggOut=`AVG.Delta.Tem/hr(Out-Egg)`)
ED1 <- ED1%>%
  rename(AVG_Temp_out_Day = `AVG.Temp.out (Day)`,
         DeltaTemp_eggOut=`Delta.avgTem/hr(Out-Egg)`)

var.test(GD1$AVG_Temp_out_Hour, ED1$AVG_Temp_out_Hour)
mean(GD1$AVG_Temp_out_Hour)
mean(ED1$AVG_Temp_out_Hour, na.rm=TRUE)

mean(GD1$AVG_Temp_egg_Hour)
#mean(GD1Daily$AVG_Temp_day)
shapiro.test(GD1$AVG_Temp_egg_Hour)
#shapiro.test(GD1Daily$AVG_Temp_day)
mean(ED1$AVG_Temp_egg_Hour)
#mean(ED1Daily$AVG_Temp_day)
shapiro.test(ED1$AVG_Temp_egg_Hour)
#shapiro.test(ED1Daily$AVG_Temp_day)
var.test(GD1$AVG_Temp_egg_Hour, ED1$AVG_Temp_egg_Hour)
#var.test(GD1Daily$AVG_Temp_day, ED1Daily$AVG_Temp_day)

T_test <- t.test(GD1$AVG_Temp_egg_Hour, ED1$AVG_Temp_egg_Hour, var.equal = TRUE)
T_test
#T_test <- t.test(GD1Daily$AVG_Temp_day, ED1Daily$AVG_Temp_day, var.equal = TRUE)
#T_test
sum(!is.na(ED1$AVG_Temp_egg_Hour))

#wilcox.test(GD1$AVG_Temp_out_Hour, ED1$AVG_Temp_out_Hour, exact = FALSE)

#Plot
boxplot(GD1$AVG_Temp_egg_Hour,ED1$AVG_Temp_egg_Hour,
        names=c("Goldeneye", "Eider"),
        main=NA, 
        ylab= "Average hourly egg temperature (°C)",
        col=c("gold", "cornflowerblue"),
        border="black",
        notch = FALSE,
        varwidth = TRUE,
        frame.plot=FALSE,
        outline=TRUE,
        axes=TRUE,
        cex.axis=1,
        cex.lab=1)
jitter <- 0.2
points(jitter(rep(1,length(GD1$AVG_Temp_egg_Hour)), amount = jitter), GD1$AVG_Temp_egg_Hour, pch=16, cex=0.8, col="black")
points(jitter(rep(2,length(ED1$AVG_Temp_egg_Hour)), amount = jitter), ED1$AVG_Temp_egg_Hour, pch=17, cex=0.8, col="black")
text(x = 1, y = max(GD1$AVG_Temp_egg_Hour, ED1$AVG_Temp_egg_Hour, na.rm = TRUE) + 0.3, labels = "*", cex=1.5)

# 3----) Truning and Temp in relation to Incubation day----
# ------In goldeneyes------

#There are only a few cases of 0 turns per day. I keep them: 
### Checking correlations 
GD2$turns_per_day<- as.integer(GD2$turns_per_day)
GD2$AVG.EggTem.Per.IncDay <- as.numeric(GD2$AVG.EggTem.Per.IncDay)
COR <- GD2[, c("Fullday.Incubation","ClutchSize", "BodyCondition","AVG.EggTem.Per.IncDay")] 
correlation_matrix <- cor(COR, method="spearman", use = "complete.obs")
#Model selection 
GD2_complete <- na.omit(GD2[, c("Fullday.Incubation","turns_per_day","ClutchSize",
                                     "FemaleID")])

Dredge_GLMM_turnPerDay=dredge(glmmTMB(turns_per_day ~  Fullday.Incubation +
                                        ClutchSize+
                                        #BodyCondition+
                                        (1|FemaleID),
                                      #ziformula = ~1,
                                      family=nbinom1(),
                                      data=GD2_complete,
                                      na.action = "na.fail"),
                              fixed = c("Fullday.Incubation")
)

View(Dredge_GLMM_turnPerDay)

# summary() of the model with the lowest AICc
summary(get.models(Dredge_GLMM_turnPerDay, subset = 1)[[1]])
summary(get.models(Dredge_GLMM_turnPerDay, subset = 2)[[1]])

#Selected model
#GD2 includes the same number of individuals. 
IncDayGold1 <- glmmTMB(turns_per_day ~ 1 + (1| FemaleID), family=nbinom1(),data = GD2_complete)
IncDayGold2 <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1| FemaleID), family=nbinom1(),data = GD2_complete) 
IncDayGold3 <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID), family=nbinom1(),data = GD2_complete)

library(MuMIn)
models <- list(
  RandomIntercept = IncDayGold1,
  FixedEffect = IncDayGold2,      
  RandomSlope = IncDayGold3
)
sapply(models, AICc)
# I removed the ziro inflation test as diagnostics proved it unnecessary
#WINNER:
IncDayGold <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID), family=nbinom1(),data = GD2_complete)
#Adding ", ziformula = ~1" did not change anything
summary(IncDayGold)
length(unique(GD2_complete$FemaleID))
IncNULL <- glmmTMB(turns_per_day ~ 1+ (1|FemaleID), family=nbinom1(), data= GD2_complete)


#Predicting the changes in turns/day to evaluate whether or not including it as covariate in the other analyses. 
range(GD2_complete$Fullday.Incubation)
newdat <- data.frame(
  Fullday.Incubation = c(1, 30),
  FemaleID = NA   # NA because we only want population-level predictions
)

pred <- predict(IncDayGold, newdata = newdat, type = "response", re.form = NA)
pred
diff(pred)#predicted on day 1 vs. day 30
#Also, the model including random slope of incubation day does not show signicance= females vary in whether incubation day affects turning rates at all. Thus, population level slope is week. 

##Checking over dispersion 
overdisp_fun <- function(model) {
  rdf <- df.residual(model)
  rp <- residuals(model, type="pearson")
  sum(rp^2)/rdf
}
overdisp_fun(IncDayGoldTemp)
#Model fit 
sim_res <- simulateResiduals(IncDayGold)
plot(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)
testOutliers(sim_res)
#Plotting 
pred <- ggpredict(IncDayGold, terms = "Fullday.Incubation")  

ggplot()+
  geom_point(data=GD2, aes(x = Fullday.Incubation, y = turns_per_day,color=factor(FemaleID)), alpha=0.6) +      
  geom_line(data = pred, aes(x = x, y = predicted), color = "#B8800B", size = 1) +
  geom_ribbon(data = pred, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2, fill = "#B8800B") +
  labs(x = "Incubation day", y = "Turns per day") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")
#AND
ggplot(GD2, aes(x = Fullday.Incubation, y = turns_per_day, color = FemaleID)) +
  geom_point(alpha = 0.5) +
  geom_line(aes(group = FemaleID), size = 0.6) +
  labs(x = "Incubation day", y = "Turns per day", color = "Female ID") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")

#####Repeatability####
IncDayGold <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1| FemaleID), family=nbinom1(),data = GD2_complete)#
#Checking egg turning dispersion 
mean(GD2_complete$turns_per_day, na.rm = TRUE)
var(GD2_complete$turns_per_day, na.rm = TRUE)
#
m0 <- glm(turns_per_day ~ 1, family = poisson(), data = GD2_complete)

disp <- sum(residuals(m0, type = "pearson")^2) / df.residual(m0)
disp

#ICC with performance::icc() # Doesn't provide CI with NB family 
#icc_val <- icc(IncDayGold)
#print(icc_val)
# RPT
rpt_result <- rpt(turns_per_day ~ Fullday.Incubation + (1|FemaleID),
                  grname = "FemaleID",  
                  data = GD2_complete,
                  datatype = "Poisson",
                  nboot = 1000,
                  npermut = 0)
summary(rpt_result) # A poisson family is used for repeatability instead of NB, since rpt does not support NB objects.

#For R2
r2_vals <- r2_nakagawa(IncDayGold) # Marginal R2= Variation explained by Incubation day. Conditional R2= Variation explained by fixed+random effect.
print(r2_vals)

#
## Temp and Incubation day ## 
GD2 <- GD2%>%
  rename(AVG_Daily_Tem = `AVG.EggTem.Per.IncDay`)
GD2$AVG_Daily_Tem <- as.numeric(GD2$AVG_Daily_Tem)

### Checking correlations 
COR <- GD2[, c("Fullday.Incubation","ClutchSize", "BodyCondition","AVG_Daily_Tem")] 
correlation_matrix <- cor(COR, method="spearman", use = "complete.obs")
#Model selection 
GD2_complete <- na.omit(GD2[, c("Fullday.Incubation","ClutchSize","AVG_Daily_Tem",
                                     "FemaleID")])

Dredge_LMer_tempPerDay=dredge(lmer(AVG_Daily_Tem ~  Fullday.Incubation +
                                        ClutchSize+
                                        #turns_per_day+  Was not significant in the selected models
                                        (1|FemaleID),
                                      data=GD2_complete,
                                      na.action = "na.fail"),
                              fixed = c()
)

View(Dredge_LMer_tempPerDay)

# summary() of the model with the lowest AICc
summary(get.models(Dredge_LMer_tempPerDay, subset = 1)[[1]])
summary(get.models(Dredge_LMer_tempPerDay, subset = 2)[[1]])

#Selected model
IncDayGoldTemp1 <- lmer(AVG_Daily_Tem ~ 1+ (1| FemaleID),data = GD2_complete) # GD2 containts the same individuals compared with GD2_complete
IncDayGoldTemp2 <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID),data = GD2_complete) # GD2 containts the same individuals compared with GD2_complete
IncDayGoldTemp3 <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID),data = GD2_complete)

library(MuMIn)
models <- list(
  RandomIntercept = IncDayGoldTemp1 ,
  FixedEffect = IncDayGoldTemp2,      
  RandomSlope = IncDayGoldTemp3
)
sapply(models, AICc)

#WINNER
IncDayGoldTemp <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID),data = GD2_complete)

summary(IncDayGoldTemp)
length(unique(GD2$FemaleID))
IncNULL <- lmer(AVG_Daily_Tem ~ 1+ (1|FemaleID), data= GD2_complete)
AIC(IncDayGoldTemp , IncNULL)

#Model fit 
sim_res <- simulateResiduals(IncDayGoldTemp)
plot(sim_res)
testDispersion(sim_res)
testZeroInflation(sim_res)
testOutliers(sim_res)
# Predicting the magnitude of change 
range(GD2$Fullday.Incubation)
newdat <- data.frame(Fullday.Incubation = c(1, 30),
                     FemaleID = NA)  # fixed effects only
pred <- predict(IncDayGoldTemp, newdata = newdat, re.form = NA)
pred
diff(pred)

## Also checking the relationship between daily turning and daily temperature
#IncDayGoldTemp <- lmer(AVG_Daily_Tem ~ turns_per_day+Fullday.Incubation + (1| FemaleID),data = GD2)

#Plotting 
pred <- ggpredict(IncDayGoldTemp, terms = "Fullday.Incubation")  

ggplot()+
  geom_point(data=GD2, aes(x = Fullday.Incubation, y = AVG_Daily_Tem,color=factor(FemaleID)), alpha=0.6) +      
  geom_line(data = pred, aes(x = x, y = predicted), color = "#B8800B", size = 1) +
  geom_ribbon(data = pred, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2, fill = "#B8800B") +
  labs(x = "Incubation day", y = "Average daily egg temperature") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")
#AND
ggplot(GD2, aes(x = Fullday.Incubation, y = AVG_Daily_Tem, color = FemaleID)) +
  geom_point(alpha = 0.5) +
  geom_line(aes(group = FemaleID), size = 0.6) +
  labs(x = "Incubation day", y = "Average daily egg temperature", color = "Female ID") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")
#
#####Repeatability####
IncDayGoldTemp <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID),data = GD2_complete)
#ICC with rptR
TEMrpt_result <- rpt(
  AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID),
  grname = "FemaleID",
  data = GD2_complete,
  datatype = "Gaussian",
  nboot = 1000,
  npermut = 0
)

summary(TEMrpt_result)

#R2
library(performance)
r2_vals <- r2_nakagawa(IncDayGoldTemp)
print(r2_vals)

#
# -------In Eiders------ 
##REMINDER: WE ALSO CHECKED WHETHER EIDERS TURN THEIR EGGS DIFFERENTLY ACROSS DIFFERENT BREEDING GROUPS (EARLY,MID,LATE):
table(ED1$Incubation_stage)
EggTurnStage <- aov(AVG_turns_hour ~ Incubation_stage, data = ED1)
summary(EggTurnStage)
pairs(emmeans(EggTurnStage, ~ Incubation_stage), adjust="tukey")
#OR
kruskal.test(AVG_turns_hour ~ Incubation_stage, data = ED1)
#AND
# Subset the data to exclude "Peak.incubation"
EggTurnStage_subset <- subset(ED1, Incubation_stage %in% c("Early.breeder", "Late.breeder"))
# Refit the model (simplified dataset)
model_subset <- lm(AVG_turns_hour ~ Incubation_stage, data = EggTurnStage_subset)
summary(model_subset)
emmeans(model_subset, pairwise ~ Incubation_stage)

#Correlations 
COR <- ED2[, c("Fullday.Incubation", "ClutchSize", "BodyCondition")]
correlation_matrix <- cor(COR, method="spearman", use = "complete.obs")

#Model selection
ED2$turns_per_day<- as.integer(ED2$turns_per_day)

ED2_complete <- na.omit(ED2[, c("Fullday.Incubation","turns_per_day","ClutchSize","FemaleID")])

Dredge_GLMM_turnPerDay=dredge(glmmTMB(turns_per_day ~  Fullday.Incubation +
                                        ClutchSize+
                                        (1|FemaleID),
                                      #ziformula=~1,
                                      family=nbinom1(),
                                      data=ED2_complete,
                                      na.action = "na.fail"),
                              fixed = c("Fullday.Incubation")
)

View(Dredge_GLMM_turnPerDay)

# summary() of the model with the lowest AICc
summary(get.models(Dredge_GLMM_turnPerDay, subset = 1)[[1]])
summary(get.models(Dredge_GLMM_turnPerDay, subset = 3)[[1]])

#Selected model
IncDayEider1 <- glmmTMB(turns_per_day ~ 1 + (1| FemaleID), family=nbinom1(),data = ED2_complete)
IncDayEider2 <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1| FemaleID), family=nbinom1(),data = ED2_complete) 
IncDayEider3 <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID), family=nbinom1(),data = ED2_complete)

library(MuMIn)
models <- list(
  RandomIntercept = IncDayEider1,
  FixedEffect = IncDayEider2,      
  RandomSlope = IncDayEider3
)
sapply(models, AICc)
#WINNER
IncDayEider <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID), family=nbinom1(),data = ED2_complete)

summary(IncDayEider)
length(unique(ED2$FemaleID))
IncNULL <- glmmTMB(turns_per_day ~ 1 + (1|FemaleID), family=nbinom1(), data=ED2_complete)
AIC(IncDayEider, IncNULL)
#Checking the model fit  
#Checking over dispersion 
overdisp_fun <- function(model) {
  rdf <- df.residual(model)
  rp <- residuals(model, type="pearson")
  sum(rp^2)/rdf
}
overdisp_fun(IncDayEider)
#
sim_res <- simulateResiduals(IncDayEider)
plot(sim_res)
testDispersion(sim_res)

#Plotting 
ggplot(ED2, aes(x = Fullday.Incubation, y = turns_per_day, color = FemaleID)) +
  geom_point(alpha = 0.5) +
  geom_line(aes(group = FemaleID), size = 0.6) +
  scale_x_continuous(
    expand = expansion(mult = c(0, 0.02)), # ensures space for last point
    breaks = pretty(ED2$Fullday.Incubation))+
  labs(x = "Incubation day", y = "Turns per day", color = "Female ID") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")

#####Repeatability####
IncDayEider <- glmmTMB(turns_per_day ~ Fullday.Incubation + (1|FemaleID), family=nbinom1(),data=ED2)
#
#Checking egg turning dispersion 
hist(ED2$turns_per_day)
mean(ED2$turns_per_day, na.rm = TRUE)
var(ED2$turns_per_day, na.rm = TRUE)
#
m0 <- glm(turns_per_day ~ 1, family = poisson(), data = ED2)

disp <- sum(residuals(m0, type = "pearson")^2) / df.residual(m0)
disp
# RPT
EDrpt_result <- rpt(turns_per_day ~ Fullday.Incubation + (1|FemaleID),
                  grname = "FemaleID",  
                  data = ED2,
                  datatype = "Poisson",
                  nboot = 1000,
                  npermut = 0)
summary(EDrpt_result)

#For R2
r2_vals <- r2_nakagawa(IncDayEider)
print(r2_vals)
#
## Temp and Incubation day ## 
#REMINDER: WE ALSO CHECKED WHETHER DIFFERENT BREEDING GRPUPS (EARLY,MID,LATE) DIFFER IN THEIR AVERAGE EGG TEMPERATURE PROVISION:
table(GD1$Incubation_stage)
GD1$Incubation_stage <- factor(
  GD1$Incubation_stage,
  levels = c("Early", "Peak", "Late")
)

ED1$Incubation_stage <- factor(
  ED1$Incubation_stage,
  levels = c("Early.breeder", "Peak.incubation", "Late.breeder")
)

EggTempStage <- aov(AVG_Temp_egg_Hour ~ Incubation_stage, data = ED1)
summary(EggTempStage)
pairs(emmeans(EggTempStage, ~ Incubation_stage), adjust="tukey")
#OR
kruskal.test(AVG_Temp_egg_Hour ~ Incubation_stage, data = ED1)
#AND
# Subset the data to exclude "Peak.incubation"
EggTempStage_subset <- subset(GD1, Incubation_stage %in% c("Early.breeder", "Late.breeder"))
# Refit the model (simplified dataset)
model_subset <- lm(AVG_Temp_egg_Hour ~ Incubation_stage, data = EggTempStage_subset)
summary(model_subset)
emmeans(model_subset, pairwise ~ Incubation_stage)

#
ED2 <- ED2%>%
  rename(AVG_Daily_Tem = `AVG.Egg.Tem.FullDay`)
ED2$AVG_Daily_Tem <- as.numeric(ED2$AVG_Daily_Tem)
### Checking correlations 
COR <- ED2[, c("Fullday.Incubation","ClutchSize", "BodyCondition","AVG_Daily_Tem","turns_per_day")] 
correlation_matrix <- cor(COR, method="spearman", use = "complete.obs")
#Model selection 
ED2_complete <- na.omit(ED2[, c("Fullday.Incubation","turns_per_day","AVG_Daily_Tem",
                                "FemaleID")])

Dredge_LMer_tempPerDay=dredge(lmer(AVG_Daily_Tem ~  Fullday.Incubation +
                                        turns_per_day+
                                     #ClutchSize+ No significant contribution 
                                        (1|FemaleID),
                                      data=ED2_complete,
                                      na.action = "na.fail"),
                              fixed = c("Fullday.Incubation")
)

View(Dredge_GLMM_tempPerDay)
# summary() of the model with the lowest AICc
summary(get.models(Dredge_GLMM_tempPerDay, subset = 1)[[1]])
summary(get.models(Dredge_GLMM_tempPerDay, subset = 2)[[1]])

#Selected model
IncDayEDTemp1 <- lmer(AVG_Daily_Tem ~ 1 + (1| FemaleID),data = ED2_complete)
IncDayEDTemp2 <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID), data = ED2_complete) 
IncDayEDTemp3 <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1+Fullday.Incubation| FemaleID),data = ED2_complete)

library(MuMIn)
models <- list(
  RandomIntercept = IncDayEDTemp1,
  FixedEffect = IncDayEDTemp2,      
  RandomSlope = IncDayEDTemp3
)
sapply(models, AICc)
#WINNER
IncDayEDTemp <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID), data = ED2_complete) 

summary(IncDayEDTemp)
length(unique(ED2_complete$FemaleID))
IncNULL <- glmmTMB(AVG_Daily_Tem ~ 1+ (1|FemaleID), data= ED2_complete)
AICc(IncDayEDTemp , IncNULL)

#Model fit 
sim_res <- simulateResiduals(IncDayEDTemp)
plot(sim_res)
testDispersion(sim_res)
testOutliers(sim_res)
# Predicting the magnitude of change 
range(ED2_complete$Fullday.Incubation)

newdat <- data.frame(Fullday.Incubation = c(1, 26),
                     FemaleID = NA)  # fixed effects only
pred<- predict(IncDayEDTemp, newdata = newdat, re.form = NA)
pred
diff(pred)
##Checking influential points 
View(ED2_complete %>%
  group_by(FemaleID) %>%
  summarise(
    min_temp = min(AVG_Daily_Tem, na.rm = TRUE),
    mean_temp = mean(AVG_Daily_Tem, na.rm = TRUE),
    sd_temp = sd(AVG_Daily_Tem, na.rm = TRUE)
  ) %>%
  arrange(min_temp)
)
#
outlierIndex <- which(sim_res$scaledResiduals < 0.025 | sim_res$scaledResiduals > 0.975)
outlier_data <- ED2_complete[outlierIndex, ]

outlier_data$residual <- sim_res$scaledResiduals[outlierIndex]

outlier_summary <- outlier_data %>%
  group_by(FemaleID) %>%
  summarise(
    n_points = n(),
    avg_residual = mean(residual)
  ) %>%
  arrange(desc(n_points))

outlier_summary
##Running the model without them
ED2_noOut <- ED2_complete[-outlierIndex, ]
ED2_noOut <- subset(ED2_complete, !(FemaleID %in% c("DT081394","DT081224","DT081305","DT081306")))
IncDayEDTemp <- glmmTMB(AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID),data = ED2_noOut)
summary(IncDayEDTemp)

## # Alos checking whether egg turning is related to egg temperature across incubation days 
#IncDayEDTemp <- lmer(AVG_Daily_Tem ~ turns_per_day +Fullday.Incubation+ (1|FemaleID),data=ED2_complete)

#Plotting 
pred <- ggpredict(IncDayEDTemp, terms = "Fullday.Incubation")  

ggplot()+
  geom_point(data=ED2_complete, aes(x = Fullday.Incubation, y = AVG_Daily_Tem,color=factor(FemaleID)), alpha=0.6) +      
  geom_line(data = pred, aes(x = x, y = predicted), color = "cornflowerblue", size = 1) +
  geom_ribbon(data = pred, aes(x = x, ymin = conf.low, ymax = conf.high), alpha = 0.2, fill = "cornflowerblue") +
  labs(x = "Incubation day", y = "Average daily egg temperature") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")
#AND
ggplot(ED2_complete, aes(x = Fullday.Incubation, y = AVG_Daily_Tem, color = FemaleID)) +
  geom_point(alpha = 0.5) +
  geom_line(aes(group = FemaleID), size = 0.6) +
  scale_x_continuous(breaks=c(0,10,20,26))+
  labs(x = "Incubation day", y = "Average daily egg temperature", color = "Female ID") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA),
    legend.position = "non")
#
#####Repeatability####
IncDayEDTemp <- lmer(AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID),data = ED2_complete)
#ICC with rptR
TEMrpt_result <- rpt(
  AVG_Daily_Tem ~ Fullday.Incubation + (1| FemaleID),
  grname = "FemaleID",
  data = ED2_complete,
  datatype = "Gaussian",
  nboot = 1000,
  npermut = 0
)
summary(TEMrpt_result)

#R2
r2_vals <- r2_nakagawa(IncDayEDTemp)
print(r2_vals)

###
##4) Exploratory-- PFAS comparison between species ####

Shapiro <- shapiro.test(GD1$PFUnA)
Shapiro
Shapiro <- shapiro.test(ED1$PFUnA)
Shapiro

# for PFAS_SUM
wilcox.test(GD1$PFAS_SUM, ED1$PFAS_SUM)
# for PFOS
wilcox.test(GD1$PFOS, ED1$PFOS)
#for PFNA
wilcox.test(GD1$PFNA, ED1$PFNA) # Eiders have higher rate of PFNA than goldeneyes
# for PFUnA
wilcox.test(GD1$PFUnA, ED1$PFUnA) # Goldeneyes has higher rate of PFUnA than eiders 

var.test(GD1$PFNA, ED1$PFNA)

##--5) PFAS-THs####
#
class(GD1$Hatch_Date)
class(GD1$Blood)
GD1$Days_to_Hatch <- as.numeric(difftime(GD1$Hatch_Date, GD1$Blood, units = "days"))
#
class(ED1$Estimated_Hatch)
class(ED1$Blood)
ED1$Days_to_Hatch <- as.numeric(difftime(ED1$Estimated_Hatch, ED1$Blood, units = "days"))
#
GD1_scaled <- GD1
GD1_scaled$PFAS_SUM <- as.numeric(scale(GD1_scaled$PFAS_SUM))
GD1_scaled$PFOS <- as.numeric(scale(GD1_scaled$PFOS))
GD1_scaled$PFUnA <- as.numeric(scale(GD1_scaled$PFUnA))
GD1_scaled$PFDoDA <- as.numeric(scale(GD1_scaled$PFDoDA))
GD1_scaled$PFNA <- as.numeric(scale(GD1_scaled$PFNA))
GD1_scaled$BodyCondition <- as.numeric(scale(GD1_scaled$BodyCondition))
GD1_scaled$Weight <- as.numeric(scale(GD1_scaled$Weight))
GD1_scaled$Days_to_Hatch <- as.numeric(scale(GD1_scaled$Days_to_Hatch))
#
ED1_scaled <- ED1
ED1_scaled$PFAS_SUM <- as.numeric(scale(ED1$PFAS_SUM))
ED1_scaled$PFOS <- as.numeric(scale(ED1$PFOS))
ED1_scaled$PFUnA <- as.numeric(scale(ED1$PFUnA))
ED1_scaled$PFHxS <- as.numeric(scale(ED1$PFHxS))
ED1_scaled$PFNA <- as.numeric(scale(ED1$PFNA))
ED1_scaled$BodyCondition <- as.numeric(scale(ED1$BodyCondition))
ED1_scaled$Weight <- as.numeric(scale(ED1$Weight))
ED1_scaled$Days_to_Hatch  <- as.numeric(scale(ED1$Days_to_Hatch))
#

GD1_subset <- GD1_scaled[, c("T4","PFAS_SUM","BodyCondition", "Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("T3_T4","PFOS","BodyCondition", "Days_to_Hatch" )]
GD1_subset <- GD1_scaled[, c("T4","PFUnA","BodyCondition",  "Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("T4","PFNA","BodyCondition", "Days_to_Hatch")]
GD1_subset <- (GD1_scaled[, c("T4","PFDoDA","BodyCondition",  "Days_to_Hatch")])
GD1_subset <- na.omit(GD1_subset)
GD1_subset$Species <- "GD"

ED1_subset <- ED1_scaled[, c("T4","PFAS_SUM","BodyCondition","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("T3_T4","PFOS","BodyCondition", "Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("T4","PFUnA","BodyCondition","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("T4","PFNA","BodyCondition",  "Days_to_Hatch")]
ED1_subset <- (ED1_scaled[, c("T4","PFHxS","BodyCondition", "Days_to_Hatch")])
ED1_subset <- na.omit(ED1_subset)
ED1_subset$Species <- "ED"

combined_data <- rbind(GD1_subset, ED1_subset)
combined_data$Species <- factor(combined_data$Species)

Dredge_LM_PFAS_THs=dredge(lm(T3_T4 ~ PFNA*Species+
                               BodyCondition*Species+
                               Days_to_Hatch,
                             data=combined_data,
                             na.action = "na.fail"),
                          fixed = c("PFNA", "Species", "PFNA:Species"),
                          rank = "AICc",
                          trace = FALSE
)

View(Dredge_LM_PFAS_THs)

summary(get.models(Dredge_LM_PFAS_THs , subset = 1)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 2)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 3)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 4)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 5)[[1]])
#
avg_mod <- model.avg(Dredge_LM_PFAS_THs)
summary(avg_mod)
# FOR THE MAJOR PFAS (PFHxS, PFDoDA) NOT COMMON IN BOTH SPECIES 
Dredge_LM_PFAS_THs <- dredge(
  lm(T4 ~ PFHxS+
       BodyCondition +
       BodyCondition:PFHxS+
       Days_to_Hatch,
     data = ED1_subset,
     na.action = "na.fail"),
  fixed = c("PFHxS"),  
)
View(Dredge_LM_PFAS_THs)
summary(get.models(Dredge_LM_PFAS_THs , subset = 1)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 2)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 3)[[1]])
summary(get.models(Dredge_LM_PFAS_THs , subset = 4)[[1]])

##OUTPUT
LM_THs<- lm(T4~ PFNA* Species+ BodyCondition*Species+Days_to_Hatch, data=combined_data)

summary(LM_THs)
nobs(LM_THs)
vif(LM_THs)

par(mfrow = c(2, 2))  
plot(LM_THs)  
shapiro.test(residuals(LM_THs))
hist(residuals(LM_THs), breaks = 20, main = "Histogram of Residuals")

#To explicitley get the slopes for each species 
library(emmeans)
emm <- emtrends(LM_THs, ~ Species, var = "PFOS")
summary(emm, infer = c(TRUE, TRUE))

# 6---- ) Nest attendance and PFAS----
###EGG TURNING#### 
GD1_scaled <- GD1
GD1_scaled$PFAS_SUM <- as.numeric(scale(GD1_scaled$PFAS_SUM))
GD1_scaled$PFOS <- as.numeric(scale(GD1_scaled$PFOS))
GD1_scaled$PFUnA <- as.numeric(scale(GD1_scaled$PFUnA))
GD1_scaled$PFDoDA <- as.numeric(scale(GD1_scaled$PFDoDA))
GD1_scaled$PFNA <- as.numeric(scale(GD1_scaled$PFNA))
GD1_scaled$T3 <- as.numeric(scale(GD1_scaled$T3))
GD1_scaled$T4 <- as.numeric(scale(GD1_scaled$T4))
GD1_scaled$ClutchSize <- as.numeric(scale(GD1_scaled$ClutchSize))
GD1_scaled$AVG_Temp_egg_Hour <- as.numeric(scale(GD1_scaled$AVG_Temp_egg_Hour))
GD1_scaled$BodyCondition <- as.numeric(scale(GD1_scaled$BodyCondition))
#GD1_scaled$Days_to_Hatch <- as.numeric(scale(GD1_scaled$Days_to_Hatch))

ED1_scaled <- ED1
ED1_scaled$PFAS_SUM <- as.numeric(scale(ED1_scaled$PFAS_SUM))
ED1_scaled$PFOS <- as.numeric(scale(ED1_scaled$PFOS))
ED1_scaled$PFUnA <- as.numeric(scale(ED1_scaled$PFUnA))
ED1_scaled$PFHxS <- as.numeric(scale(ED1_scaled$PFHxS))
ED1_scaled$PFNA <- as.numeric(scale(ED1_scaled$PFNA))
ED1_scaled$T3 <- as.numeric(scale(ED1_scaled$T3))
ED1_scaled$T4 <- as.numeric(scale(ED1_scaled$T4))
ED1_scaled$ClutchSize <- as.numeric(scale(ED1_scaled$ClutchSize))
ED1_scaled$AVG_Temp_egg_Hour <- as.numeric(scale(ED1_scaled$AVG_Temp_egg_Hour))
ED1_scaled$BodyCondition <- as.numeric(scale(ED1_scaled$BodyCondition))
#ED1_scaled$Days_to_Hatch <- as.numeric(scale(ED1_scaled$Days_to_Hatch))
#Testing whether or not to add clutch size for each species 
summary(GD1$ClutchSize)
sd(GD1$ClutchSize)
#
summary(ED1$ClutchSize)
sd(ED1$ClutchSize, na.rm = TRUE)
table(ED1$ClutchSize)
total_nests <- sum(!is.na(ED1$ClutchSize))
n_3_5 <- sum(ED1$ClutchSize >= 3 & ED1$ClutchSize <= 5, na.rm = TRUE)
prop_3_5 <- n_3_5 / total_nests
prop_3_5
## 
#Combining goldeneye and eider dataset 
#GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T4","ClutchSize")]# Also tried for ONLY T3, but there was nothing across species 
#GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFAS_SUM","ClutchSize")] #We first selected the model including clutch size, but for the chosen model, we run the dataset without clutch size if the output remains the same and clutch size is not included in the chosen model
GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFAS_SUM")]
#GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFAS_SUM", "Days_to_Hatch","ClutchSize")]
#GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFOS","ClutchSize")]
GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFOS")]
#GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFOS","Days_to_Hatch","ClutchSize")]
#GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFUnA","ClutchSize","Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFUnA")]
GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFNA","ClutchSize","Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("AVG_turns_hour","T3","PFDoDA","ClutchSize","Days_to_Hatch")]
GD1_subset <- na.omit(GD1_subset)
GD1_subset$Species <- "Goldeneye"

#ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T4","ClutchSize")]# ONLY WITH T3
#ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFAS_SUM","ClutchSize")]
ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFAS_SUM")]
#ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFAS_SUM","Days_to_Hatch","ClutchSize")]
#ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFOS","ClutchSize")]
ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFOS")]
#ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFOS","Days_to_Hatch","ClutchSize")]
#ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFUnA","ClutchSize","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFUnA")]
ED1_subset <- ED1_scaled[, c("AVG_turns_hour","T3","PFNA","ClutchSize","Days_to_Hatch")]
ED1_subset <- na.omit(ED1_scaled[, c("AVG_turns_hour","T3","PFHxS","ClutchSize")])
ED1_subset <- na.omit(ED1_subset)
ED1_subset$Species <- "Eider"

combined_data <- rbind(GD1_subset, ED1_subset)
# Correlation test 
COR <- combined_data[, c("AVG_turns_hour","T3","PFAS_SUM","ClutchSize")]
correlation_matrix <- cor(COR, method="spearman", use = "complete.obs")
res <- rcorr(as.matrix(COR), type = "spearman")
res$r   
res$P 

#
Dredge_LM_Turns <- dredge(
  lm(AVG_turns_hour ~ PFNA*Species +
       T3+
       Days_to_Hatch+
       ClutchSize,
     data = combined_data,
     na.action = "na.fail"),
  fixed = c("PFNA","Species","PFNA:Species"),
  rank = "AICc",
  trace = FALSE
)

View(Dredge_LM_Turns)

summary(get.models(Dredge_LM_Turns , subset = 1)[[1]])
summary(get.models(Dredge_LM_Turns , subset = 2)[[1]])
summary(get.models(Dredge_LM_Turns , subset = 3)[[1]])
summary(get.models(Dredge_LM_Turns , subset = 4)[[1]])

# FOR THE MAJOR PFAS NOT COMMON IN BOTH SPECIES: PFDoDA and PFHxS
Dredge_LM_Turns <- dredge(
  lm(AVG_turns_hour ~ PFHxS+ T3 + 
       #BodyCondition +
       #BodyCondition:T3 + BodyCondition:PFUnA+
       ClutchSize+
       ClutchSize:PFHxS,
     data = ED1_subset,
     na.action = "na.fail"),
  fixed = c(),  
)
View(Dredge_LM_Turns)
summary(get.models(Dredge_LM_Turns , subset = 1)[[1]])
summary(get.models(Dredge_LM_Turns , subset = 2)[[1]])
summary(get.models(Dredge_LM_Turns , subset = 3)[[1]])
summary(get.models(Dredge_LM_Turns , subset = 4)[[1]])

##OUTPUT
LM_Turns<- lm(AVG_turns_hour~ PFAS_SUM*Species, data=combined_data) #For all significant models: Refitting and reporting the model on the largest possible dataset, if the output remains the same
#
LM_PFOS<- lm(AVG_turns_hour~ PFOS*Species, data=combined_data)
#
LM_PFUnA<- lm(AVG_turns_hour~ PFUnA*Species, data=combined_data)
#LM_PFNA<- lm(AVG_turns_hour~ PFNA*Species, data=combined_data)

#LM_Turns<- lm(AVG_turns_hour~ PFDoDA, data=GD1_Subset)
#LM_Turns<- lm(AVG_turns_hour~ PFHxS, data=ED1_Subset)
summary(LM_Turns) 
nobs(LM_Turns) 
car::vif(LM_Turns, type = "predictor") 
#To explicitley get the slopes for each species 
library(emmeans)
emm <- emtrends(LM_Turns, ~ Species, var = "PFAS_SUM")
summary(emm, infer = c(TRUE, TRUE))
# Model fit testing 
#
par(mfrow = c(2, 2))  
plot(LM_Turns)  
shapiro.test(residuals(LM_Turns))
hist(residuals(LM_Turns), breaks = 20, main = "Histogram of Residuals")

# Plot
ggplot(combined_data, aes(x = PFAS_SUM, y = AVG_turns_hour, color = Species, shape=Species)) +
  geom_point(alpha = 0.8,size = 2) +
  geom_smooth(aes(fill = Species), method = "lm", se = TRUE, alpha = 0.2) +
  scale_color_manual(values = c("Goldeneye" = "#B8923B", "Eider" = "cornflowerblue")) +
  scale_fill_manual(values = c("Goldeneye" = "#B8923B", "Eider" = "cornflowerblue")) +
  scale_shape_manual(values = c("Goldeneye" = 16,
                                "Eider" = 17))+
  labs(x = "???PFAS",
       y =  "Turning frequency (h???¹)",
       title="") +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )

# FOR Major compounds in common between two species 
emm_PFOS  <- emtrends(LM_PFOS,  ~ Species, var = "PFOS")
emm_PFUnA <- emtrends(LM_PFUnA, ~ Species, var = "PFUnA")
emm_PFNA  <- emtrends(LM_PFNA,  ~ Species, var = "PFNA")

slopes <- bind_rows(
  summary(emm_PFOS, infer = TRUE) %>% 
    rename(estimate = PFOS.trend) %>% 
    mutate(compound = "PFOS"),
  summary(emm_PFUnA, infer = TRUE) %>% 
    rename(estimate = PFUnA.trend) %>% 
    mutate(compound = "PFUnA"),
  summary(emm_PFNA, infer = TRUE) %>% 
    rename(estimate = PFNA.trend) %>% 
    mutate(compound = "PFNA")
) %>% 
  mutate(
    sig_label = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE ~ ""
    ),
    dashed_ci = Species == "Goldeneye" & compound == "PFUnA"
  )

species_colors <- list(
  "Eider" = c("PFUnA" = "#B3D1FF", "PFNA" = "#82B3FF", "PFOS" = "cornflowerblue"),
  "Goldeneye" = c("PFNA" = "#E6C36A", "PFUnA" = "#C89B3C", "PFOS" = "#7A4F1D")
)

slopes <- slopes %>%
  rowwise() %>%
  mutate(color = species_colors[[Species]][compound]) %>%
  ungroup()

ggplot(slopes, aes(x = estimate, y = reorder(compound, estimate), color = color)) +
  geom_point(
    position = position_dodge(width = 0.6),
    size = 3
  ) +
  geom_errorbarh(
    aes(
      xmin = lower.CL,
      xmax = upper.CL,
      linetype = dashed_ci
    ),
    height = 0.2,
    position = position_dodge(width = 0.6)
  ) +
  geom_text(
    aes(label = sig_label),
    position = position_dodge(width = 0.6),
    hjust = -0.3,
    vjust = 0.2,
    size = 5
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed",
    color = "gray40"
  ) +
  labs(
    x = expression("Slope of PFAS effect on egg turning rate (" * h^{-1} * ")"),
    y = "Major PFAS",
    title = "(B)"
  ) +
  scale_color_identity() +
  scale_linetype_manual(
    values = c(`TRUE` = "dashed", `FALSE` = "solid"),
    guide = "none"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.position = "right"
  )

##EGG TEMP####
#We should keep recorded duration and average egg turning, as fixed effects. 
GD1_scaled <- GD1
GD1_scaled$PFAS_SUM <- as.numeric(scale(GD1_scaled$PFAS_SUM))
GD1_scaled$T3 <- as.numeric(scale(GD1_scaled$T3))
GD1_scaled$AVG_turns_hour <- as.numeric(scale(GD1_scaled$AVG_turns_hour))
GD1_scaled$ClutchSize <- as.numeric(scale(GD1_scaled$ClutchSize))
GD1_scaled <- GD1_scaled%>%
  rename( Days.recorded =RecordedDays)
GD1_scaled$Days.recorded <- as.numeric(scale(GD1_scaled$Days.recorded))
GD1_scaled$Days_to_Hatch <- as.numeric(scale(GD1_scaled$Days_to_Hatch))
GD1_scaled$AVG_Temp_out_Hour <- as.numeric(scale(GD1_scaled$AVG_Temp_out_Hour))

ED1_scaled <- ED1
ED1_scaled$PFAS_SUM <- as.numeric(scale(ED1_scaled$PFAS_SUM))
ED1_scaled$T3 <- as.numeric(scale(ED1_scaled$T3))
ED1_scaled$AVG_turns_hour <- as.numeric(scale(ED1_scaled$AVG_turns_hour))
ED1_scaled$ClutchSize <- as.numeric(scale(ED1_scaled$ClutchSize))
ED1_scaled$Days.recorded <- as.numeric(scale(ED1_scaled$Days.recorded))
ED1_scaled$Days_to_Hatch <- as.numeric(scale(ED1_scaled$Days_to_Hatch))
ED1_scaled$AVG_Temp_out_Hour <- as.numeric(scale(ED1_scaled$AVG_Temp_out_Hour))
#
## We selected the model while including clutch size. If clutch size was not included in the selected model, we ran the final model without clutch size also to use the max observations
#GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFAS_SUM","Days.recorded","ClutchSize","Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFAS_SUM","T3")]
#GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFOS","Days.recorded","ClutchSize","Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFOS")]
#GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFUnA","Days.recorded","ClutchSize","Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFUnA")]
#GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFNA","Days.recorded","ClutchSize","Days_to_Hatch")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFNA")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFDoDA","Days.recorded")]
GD1_subset <- na.omit(GD1_subset)
GD1_subset$Species <- "Goldeneye"

#ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFAS_SUM","Days.recorded","ClutchSize","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFAS_SUM","T3")]
#ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFOS","Days.recorded", "ClutchSize","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFOS")]
#ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFUnA","Days.recorded","ClutchSize","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFUnA")]
#ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFNA","Days.recorded","ClutchSize","Days_to_Hatch")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFNA")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFHxS","Days.recorded", "ClutchSize", "Days_to_Hatch")]
ED1_subset <- na.omit(ED1_subset)
ED1_subset$Species <- "Eider"

combined_data <- rbind(GD1_subset, ED1_subset)

Dredge_LM_Temp=dredge(lm(AVG_Temp_egg_Hour ~  PFAS_SUM* Species+ 
                           T3+
                           ClutchSize+
                           Days_to_Hatch+
                              AVG_turns_hour+
                           Days.recorded+
                           #AVG_Temp_out_Hour, We confirmed that adding the average hourly ambient temperature was not a significant component in model selection.
                            data=combined_data,
                            na.action = "na.fail"),
                      fixed = c("PFAS_SUM","Species","PFAS_SUM:Species"),
                      rank = "AICc",
                      trace = FALSE
)

View(Dredge_LM_Temp)
summary(get.models(Dredge_LM_Temp , subset = 1)[[1]])
summary(get.models(Dredge_LM_Temp , subset = 2)[[1]])
summary(get.models(Dredge_LM_Temp , subset = 3)[[1]])
summary(get.models(Dredge_LM_Temp , subset = 4)[[1]])
summary(get.models(Dredge_LM_Temp , subset = 5)[[1]])

model.avg(Dredge_LM_Temp)
sw(Dredge_LM_Temp)

##FOR major compounds that differ between species: PFDoDA and PFHxS
Dredge_LM_Temp=dredge(lm(AVG_Temp_egg_Hour ~  PFHxS+ T3+
                           AVG_turns_hour+
                           ClutchSize+
                           Days_to_Hatch+
                           Days.recorded,
                         data=ED1_subset,
                         na.action = "na.fail"),
                      fixed = c("PFHxS"),
)
View(Dredge_LM_Temp)
summary(get.models(Dredge_LM_Temp , subset = 1)[[1]])
summary(get.models(Dredge_LM_Temp , subset = 2)[[1]])
summary(get.models(Dredge_LM_Temp , subset = 3)[[1]])

#
#OUTPUT1) 
#FOR all significant models, re-fitting and reporting the largest possible dataste, if the output remains unchanged. Also, including Incubation_stage did not change the result 
LM_Temp <- lm(AVG_Temp_egg_Hour~ AVG_turns_hour+PFAS_SUM*Species, data=combined_data)
summary(LM_Temp)

#
LM_TempPFOS <- lm(AVG_Temp_egg_Hour~ AVG_turns_hour+PFOS*Species, data=combined_data)
summary(LM_TempPFOS)
#
#LM_TempPFUnA <- lm(AVG_Temp_egg_Hour~ PFUnA*Species+AVG_turns_hour, data=combined_data)
#LM_TempPFNA <- lm(AVG_Temp_egg_Hour~ PFNA*Species+AVG_turns_hour, data=combined_data)
summary(LM_Temp)
nobs(LM_Temp)
car::vif(LM_Temp, type = "predictor")
#
#To explicitley get the slopes for each species 
library(emmeans)
emm <- emtrends(LM_Temp, ~ Species, var = "PFAS_SUM")
summary(emm, infer = c(TRUE, TRUE))

#Model fit check 
par(mfrow = c(2, 2))  
plot(LM_Temp)  
shapiro.test(residuals(LM_Temp))
hist(residuals(LM_Temp), breaks = 20, main = "Histogram of Residuals")

# 7--Explanatory):
#For the relationship between egg turning and temperature 
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","Days.recorded")]
GD1_subset <- na.omit(GD1_subset)
GD1_subset$Species <- "Goldeneye"

ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","Days.recorded")]
ED1_subset <- na.omit(ED1_subset)
ED1_subset$Species <- "Eider"

combined_data <- rbind(GD1_subset, ED1_subset)

LM_Temp <- lm(AVG_Temp_egg_Hour~ Species*AVG_turns_hour+Days.recorded, data=combined_data)

#Checking whether PFAS is linked with recorded duration 
names(ED1)[names(ED1) == "Total record (Hour)"] <- "Hours_recorded"
ED1$Hours_recorded <- as.numeric(ED1$Hours_recorded)
class(ED1$PFAS_SUM)
ED1$Days.recorded <- as.numeric(ED1$Days.recorded)

model1 <- lm(PFAS_SUM ~ Days.recorded, data = ED1)
model1 <- lm(PFOS ~ Days.recorded, data = ED1)
summary(model1)
nobs(model1)

par(mfrow = c(2, 2))  
plot(model1)  
shapiro.test(residuals(model1))
hist(residuals(model1), breaks = 20, main = "Histogram of Residuals")


ggplot(ED1, aes(x = Days.recorded, y = PFAS_SUM)) +
  geom_point(color = "#B8923B") +
  geom_smooth(method = "lm", se = TRUE, color = "#B8923B",fill  = "#B8923B") +
  labs(x = "Recorded duration (days)",
       y = "???PFAS",
       title = "") +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )

# PLOT
ggplot(combined_data, aes(x = PFAS_SUM, y = AVG_Temp_egg_Hour, color = Species, shape=Species)) +
  geom_point(alpha = 0.8, size=2) +
  geom_smooth(aes(fill = Species), method = "lm", se = TRUE, alpha = 0.2) +
  scale_color_manual(values = c("Goldeneye" = "#B8923B", "Eider" = "cornflowerblue")) +
  scale_fill_manual(values = c("Goldeneye" = "#B8923B", "Eider" = "cornflowerblue")) +
  scale_shape_manual(values = c("Goldeneye" = 16,
                                "Eider" = 17))+
  labs(x = "???PFAS",
       y = "Average hourly egg temperature (°C)",
       title="(A)") +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black")
  )

# FOR Major compounds in common between two species 
emm_PFOS  <- emtrends(LM_TempPFOS,  ~ Species, var = "PFOS")
emm_PFUnA <- emtrends(LM_TempPFUnA, ~ Species, var = "PFUnA")
emm_PFNA  <- emtrends(LM_TempPFNA,  ~ Species, var = "PFNA")

slopes <- bind_rows(
  summary(emm_PFOS, infer = TRUE) %>% 
    rename(estimate = PFOS.trend) %>% 
    mutate(compound = "PFOS"),
  summary(emm_PFUnA, infer = TRUE) %>% 
    rename(estimate = PFUnA.trend) %>% 
    mutate(compound = "PFUnA"),
  summary(emm_PFNA, infer = TRUE) %>% 
    rename(estimate = PFNA.trend) %>% 
    mutate(compound = "PFNA")
) %>% 
  mutate(sig_label = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01  ~ "**",
    p.value < 0.05  ~ "*",
    TRUE ~ ""
  ))

species_colors <- list(
  "Eider" = c("PFUnA" = "#B3D1FF", "PFNA" = "#82B3FF", "PFOS" = "cornflowerblue"),
  "Goldeneye" = c("PFNA" = "gold2","PFUnA" = "#D1A12C", "PFOS" = "#8B6E3C")
)

slopes <- slopes %>%
  rowwise() %>%
  mutate(color = species_colors[[Species]][compound]) %>%
  ungroup()


ggplot(slopes, aes(x = estimate, y = reorder(compound, estimate), color = color)) +
  geom_point(position = position_dodge(width = 0.6), size = 3) +
  geom_errorbarh(aes(xmin = lower.CL, xmax = upper.CL), height = 0.2,
                 position = position_dodge(width = 0.6)) +
  geom_text(aes(label = sig_label), position = position_dodge(width = 0.6),
            hjust = 0.4, vjust = 0.0, size = 5) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(
    x = "Slope of PFAS correlation with egg temperature (°C)",
    y = "Major PFAS",
    title = "(B)"
  ) +
  scale_color_identity() +  # use the colors directly from the column
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.position = "right"
  )

# For egg turning and temperature 
ggplot(combined_data, aes(x = AVG_turns_hour, y = AVG_Temp_egg_Hour, color = Species, shape=Species)) +
  geom_point(alpha = 0.8, size = 2) +
  geom_smooth(aes(fill = Species), method = "lm", se = TRUE, alpha = 0.2) +
  scale_color_manual(values = c("Goldeneye" = "#B8923B", "Eider" = "cornflowerblue")) +
  scale_fill_manual(values = c("Goldeneye" = "#B8923B", "Eider" = "cornflowerblue")) +
  scale_shape_manual(values = c("Goldeneye" = 16,
                                "Eider" = 17))+
  labs(
    x = "Average egg turning frequency (h-¹)",
    y = "Average egg temperature (°C)",
    title = ""
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    legend.position = "top"
  )

#
#---- 7) Hatching success, turning frequency, egg temperature and PFAS ----
GD1 <- GD1%>%
  rename(Hatched_eggs = `Hatched eggs`)
ED1 <- ED1%>%
  rename(Hatched_eggs= `Hatched remains`)

GD1_scaled <- GD1
GD1_scaled$PFAS_SUM <- as.numeric(scale(GD1_scaled$PFAS_SUM))
GD1_scaled$AVG_Temp_egg_Hour <- as.numeric(scale(GD1_scaled$AVG_Temp_egg_Hour))
#GD1_scaled$BodyCondition <- as.numeric(scale(GD1_scaled$BodyCondition))
GD1_scaled$T3 <- as.numeric(scale(GD1_scaled$T3))
GD1_scaled$AVG_turns_hour <- as.numeric(scale(GD1_scaled$AVG_turns_hour))

ED1_scaled <- ED1
ED1_scaled$PFAS_SUM <- as.numeric(scale(ED1_scaled$PFAS_SUM))
ED1_scaled$AVG_Temp_egg_Hour <- as.numeric(scale(ED1_scaled$AVG_Temp_egg_Hour))
#ED1_scaled$BodyCondition <- as.numeric(scale(ED1_scaled$BodyCondition))
ED1_scaled$T3 <- as.numeric(scale(ED1_scaled$T3))
ED1_scaled$AVG_turns_hour <- as.numeric(scale(ED1_scaled$AVG_turns_hour))
ED1_scaled$Hatched_eggs <- as.numeric(as.character(ED1_scaled$Hatched_eggs))

GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","PFAS_SUM","Hatched_eggs","ClutchSize")]
GD1_subset <- GD1_scaled[, c("PFAS_SUM","Hatched_eggs","ClutchSize")] # Only PFAS
#GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","Hatched_eggs","ClutchSize")] # Only temperature
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFOS","Hatched_eggs","ClutchSize")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFUnA","Hatched_eggs","ClutchSize")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFNA","Hatched_eggs","ClutchSize")]
GD1_subset <- GD1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFDoDA","Hatched_eggs","ClutchSize")]
GD1_subset <- na.omit(GD1_subset)
GD1_subset$Species <- "Goldeneye"

ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","PFAS_SUM","Hatched_eggs","ClutchSize")]
ED1_subset <- ED1_scaled[, c("PFAS_SUM","Hatched_eggs","ClutchSize")]
ED1_subset <- ED1_scaled[, c("PFAS_SUM","Hatched_eggs","ClutchSize")] # Only PFAS
#ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","Hatched_eggs","ClutchSize")] # only for temperature 
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFOS","Hatched_eggs","ClutchSize")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFUnA","Hatched_eggs","ClutchSize")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFNA","Hatched_eggs","ClutchSize")]
ED1_subset <- ED1_scaled[, c("AVG_Temp_egg_Hour","AVG_turns_hour","PFHxS","Hatched_eggs","ClutchSize")]
ED1_subset <- na.omit(ED1_subset)
ED1_subset$Species <- "Eider"

combined_data <- rbind(GD1_subset, ED1_subset)
combined_data$ClutchSize <- as.numeric(as.character(combined_data$ClutchSize))
combined_data$Hatched_eggs <- as.numeric(as.character(combined_data$Hatched_eggs))
combined_hatch <- na.omit(combined_data[, c("Species","PFAS_SUM","Hatched_eggs","ClutchSize","AVG_Temp_egg_Hour")])
#combined_hatch <- na.omit(combined_data[, c("Species","T3","PFAS_SUM","Hatched_eggs","ClutchSize")])

Dredge_Hatch <- dredge(
  glm(
    cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~  
      PFAS_SUM * Species + 
      AVG_Temp_egg_Hour,
      #AVG_turns_hour,
    data = combined_hatch,
    family = binomial(),
    na.action = "na.fail"
  ),
  fixed = c("PFAS_SUM","Species","PFAS_SUM:Species"),
  rank = "AICc",
  trace = FALSE
)
#Quasibinomial
Dredge_Hatch <- dredge(
  glm(cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~  
      PFAS_SUM * Species + 
      AVG_Temp_egg_Hour,
      #AVG_turns_hour,
    data = combined_hatch,
    family = quasibinomial(),
    na.action = "na.fail"
  ),
  fixed = c("PFAS_SUM","Species","PFAS_SUM:Species"),
  trace = FALSE 
)


View(Dredge_Hatch)
summary(get.models(Dredge_Hatch , subset = 1)[[1]])
summary(get.models(Dredge_Hatch , subset = 2)[[1]])
summary(get.models(Dredge_Hatch , subset = 3)[[1]])
summary(get.models(Dredge_Hatch , subset = 4)[[1]])

# FOR THE MAJOR PFAS NOT COMMON IN BOTH SPECIES: PFDoDA & PFHxS
ED1_subset$ClutchSize <- as.numeric(as.character(ED1_subset$ClutchSize))
ED1_subset$Hatched_eggs <- as.numeric(as.character(ED1_subset$Hatched_eggs))
ED1_subset_clean<- na.omit(ED1_subset[, c("AVG_Temp_egg_Hour","AVG_turns_hour","T3","PFHxS","Hatched_eggs","ClutchSize")])


Dredge_Hatch <- dredge(
  glm(
    cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~  
      PFHxS + 
      AVG_Temp_egg_Hour+
      AVG_turns_hour+
      T3,
    data = ED1_subset_clean,
    family = binomial(),
    na.action = "na.fail"
  ),
  fixed = c("")
)

summary(get.models(Dredge_Hatch , subset = 1)[[1]])
summary(get.models(Dredge_Hatch , subset = 2)[[1]])
summary(get.models(Dredge_Hatch , subset = 3)[[1]])
summary(get.models(Dredge_Hatch , subset = 4)[[1]])
##OUTPUT
#PFAS with and without egg temperature 
glm_Hatch1 <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~  PFAS_SUM*Species + AVG_Temp_egg_Hour, data = combined_hatch, family = quasibinomial())

glm_Hatch2 <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~ AVG_Temp_egg_Hour, data = combined_hatch, family = quasibinomial())

anova(glm_Hatch1, glm_Hatch2, test = "F")
#AND: ONLY FOR PFAS
glm_Hatch <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~ 
    Species+PFAS_SUM , data = combined_hatch, family = quasibinomial())

glm_Hatch <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~ 
    Species*PFAS_SUM , data = combined_hatch, family = quasibinomial())
#AND: ONLY FOR EGG TEMPERATURE
glm_HatchT <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~ AVG_Temp_egg_Hour+Species, data = combined_hatch, family = quasibinomial()) 
glm_HatchT <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~ AVG_Temp_egg_Hour*Species, data = combined_hatch, family = quasibinomial()) 


anova(glm_HatchT, glm_Hatch, test = "F")

summary(glm_Hatch2)
nobs(glm_Hatch)
vif(glm_Hatch)
#To explicitly get the slopes for each species 
emm <- emtrends(glm_Hatch, ~ Species, var = "PFAS_SUM")
summary(emm, infer = c(TRUE, TRUE))
#
#Model check
par(mfrow=c(2,2))
plot(glm_Hatch)
par(mfrow=c(1,1))

#Only for binomial 
simres <- simulateResiduals(glm_Hatch, n=1000) 
plot(simres)
testDispersion(simres)
# AND
overdispersion <- sum(residuals(glm_HatchPFOS, type="pearson")^2) /
  df.residual(glm_HatchPFOS)

overdispersion # High overdispersion with binomial family. Thus, I switch to quasibinomial. But that won't change the overdispersion value 

#
#Influential points
cooksd <- cooks.distance(glm_Hatch)
plot(cooksd, type = "h", main = "Cook's Distance")
abline(h = 4/(nrow(combined_hatch) - length(coef(glm_Hatch)) - 1), col = "red", lty = 2)
infl_obs<- which(cooksd > 4/(nrow(combined_hatch) - length(coef(glm_Hatch)) - 1))
infl_obs
#To make sure which observation is the influential 
as.numeric(rownames(glm_Hatch$model)[infl_obs])

#IF needed! Re-running the model with the subset, excluding the influential points: 
combined_sub<- combined_hatch[-c(5,12,25), ]  # Removes the second row
#MODEL
glm_Hatch <- glm(
  cbind(Hatched_eggs, ClutchSize - Hatched_eggs) ~ 
    PFAS_SUM * Species + AVG_Temp_egg_Hour, data = combined_sub, family = quasibinomial()) 
summary(glm_Hatch)
nobs(glm_Hatch)
#
# PLOT: PFAS
visreg(
  glm_Hatch,
  xvar = "PFAS_SUM",
  by = "Species",
  scale = "response",     # convert logit ??? probability
  overlay = TRUE,         # show both species together
  rug = FALSE,            # no rug marks
  band = TRUE,            # 95% CI bands
  xlab = "PFAS (SUM)",
  ylab = "Predicted hatching probability",
  main = ""
)
#
#TEMP
GD1_subset <- GD1[, c("AVG_Temp_egg_Hour","Hatched_eggs","ClutchSize")]

GD1_subset <- na.omit(GD1_subset)
GD1_subset$Species <- "Goldeneye"

ED1_subset <- ED1[, c("AVG_Temp_egg_Hour","Hatched_eggs","ClutchSize")]

ED1_subset <- na.omit(ED1_subset)
ED1_subset$Species <- "Eider"

combined_data <- rbind(GD1_subset, ED1_subset)
combined_data$ClutchSize <- as.numeric(as.character(combined_data$ClutchSize))
combined_data$Hatched_eggs <- as.numeric(as.character(combined_data$Hatched_eggs))
combined_hatch <- na.omit(combined_data[, c("Species","AVG_Temp_egg_Hour","Hatched_eggs","ClutchSize")])

combined_hatch$HatchProp <- combined_hatch$Hatched_eggs / combined_hatch$ClutchSize

ggplot(combined_hatch, aes(x = AVG_Temp_egg_Hour, y = HatchProp, color = Species, shape=Species)) +
  geom_jitter(width = 0.05, height = 0.02, size = 2) +
  geom_smooth(aes(fill = Species), method = "lm", se = TRUE, alpha = 0.2) +
  scale_y_continuous(limits = c(0, 1), oob = scales::squish) +
  scale_color_manual(values = c("Eider" = "cornflowerblue", "Goldeneye" = "#B8923B")) +
  scale_fill_manual(values = c("Eider" = "cornflowerblue", "Goldeneye" = "#B8923B")) +
  scale_shape_manual(values = c("Eider" = 17, "Goldeneye" = 16))+
  labs(
    x = "Egg temperature (h???¹)",
    y = "Hatching Success (proportion)",
    color = "Species",
    fill = "Species"
  ) +
  theme_classic()

#
###--Bootstrapping the sig. results----####
#Eider vs. Goldeneye 
T_test <- t.test(GD1$AVG_Temp_egg_Hour, ED1$AVG_Temp_egg_Hour, var.equal = TRUE)
T_test
boot_fun_t <- function(data, indices) {
  d <- data[indices, ]
  mean(d$value[d$group == "Goldeneye"]) -
    mean(d$value[d$group == "Eider"])
}

boot_data <- data.frame(
  value = c(GD1$AVG_Temp_egg_Hour, ED1$AVG_Temp_egg_Hour),
  group = c(rep("Goldeneye", length(GD1$AVG_Temp_egg_Hour)),
            rep("Eider", length(ED1$AVG_Temp_egg_Hour)))
)

set.seed(123)
boot_results_t <- boot(data = boot_data, statistic = boot_fun_t, R = 5000)

boot_results_t
boot.ci(boot_results_t, type = "perc")

#1)
LM_Turns<- lm(AVG_turns_hour~ PFAS_SUM*Species, data=combined_data)
summary(LM_Turns)
#---#
library(boot)

boot_fun_gold <- function(data, indices) {
  d <- data[indices, ]
  fit <- lm(
    AVG_turns_hour ~ PFAS_SUM * Species,
    data = d
  )
  coef(fit)["PFAS_SUM"] +
    coef(fit)["PFAS_SUM:SpeciesGoldeneye"]
}

set.seed(123)
boot_gold <- boot(
  data = combined_data,
  statistic = boot_fun_gold,
  R = 5000
)

# Bootstrap CIs
boot.ci(boot_gold, type = "perc")
boot.ci(boot_gold, type = "bca")


#PLOT 1)
plot_data <- data.frame(slope = boot_vals)

ggplot(plot_data, aes(x = slope)) +
  geom_histogram(binwidth = 0.02, fill = "white", color = "black", alpha = 0.7) +
  geom_vline(xintercept = orig_val, color = "red", size = 1.2) +
  geom_vline(xintercept = ci_gold, color = "green", linetype = "dashed", size = 1) +
  labs(
    title = "",
    x = "Bootstrap slope estimates",
    y = "Frequency"
  ) +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA)
  )

#2)
LM_PFOS<- lm(AVG_turns_hour~ PFOS*Species, data=combined_data)
summary(LM_PFOS)

boot_fun_gold <- function(data, indices) {
  d <- data[indices, ]
  fit <- lm(AVG_turns_hour ~ PFOS*Species, data = d)
  
  em <- emtrends(fit, ~Species, var = "PFOS") |> summary(infer = FALSE)
  
  if("Goldeneye" %in% em$Species) {
    return(em$PFOS.trend[em$Species == "Goldeneye"])
  } else {
    return(NA)
  }
}

set.seed(123)
boot_gold <- boot(combined_data, statistic = boot_fun_gold, R = 5000)
boot_gold 
#Bootstap distribution and CI:
boot_vals <- boot_gold$t[,1]
orig_val  <- boot_gold$t0
ci_gold <- boot.ci(boot_gold, type = "perc")$percent[4:5]
ci_gold

#PLOT 2)
plot_data <- data.frame(slope = boot_vals)

ggplot(plot_data, aes(x = slope)) +
  geom_histogram(binwidth = 0.02, fill = "white", color = "black", alpha = 0.7) +
  geom_vline(xintercept = orig_val, color = "red", size = 1.2) +
  geom_vline(xintercept = ci_gold, color = "green", linetype = "dashed", size = 1) +
  labs(
    title = "",
    x = "Bootstrap slope estimates",
    y = "Frequency"
  ) +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA)
  )


#
#3)
LM_PFUnA<- lm(AVG_turns_hour~ PFUnA*Species, data=combined_data)
summary(LM_PFUnA)

boot_fun_gold <- function(data, indices) {
  d <- data[indices, ]
  fit <- lm(AVG_turns_hour ~ PFUnA*Species, data = d)
  
  em <- emtrends(fit, ~Species, var = "PFUnA") |> summary(infer = FALSE)
  
  if("Goldeneye" %in% em$Species) {
    return(em$PFUnA.trend[em$Species == "Goldeneye"])
  } else {
    return(NA)
  }
}

set.seed(123)
boot_gold <- boot(combined_data, statistic = boot_fun_gold, R = 5000)
boot_gold 
#Bootstap distribution and CI:
boot_vals <- boot_gold$t[,1]
orig_val  <- boot_gold$t0
ci_gold <- boot.ci(boot_gold, type = "perc")$percent[4:5]
ci_gold

#PLOT 3)
plot_data <- data.frame(slope = boot_vals)

ggplot(plot_data, aes(x = slope)) +
  geom_histogram(binwidth = 0.02, fill = "white", color = "black", alpha = 0.7) +
  geom_vline(xintercept = orig_val, color = "red", size = 1.2) +
  geom_vline(xintercept = ci_gold, color = "green", linetype = "dashed", size = 1) +
  labs(
    title = "",
    x = "Bootstrap slope estimates",
    y = "Frequency"
  ) +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA)
  )

#
#4)
LM_Temp <- lm(AVG_Temp_egg_Hour~ AVG_turns_hour+PFAS_SUM*Species, data=combined_data)
summary(LM_Temp)
#
LM_TempPFOS <- lm(AVG_Temp_egg_Hour~ AVG_turns_hour+PFOS*Species, data=combined_data)
summary(LM_TempPFOS)

boot_fun_eider <- function(data, indices) {
  d <- data[indices, ]
  fit <- lm(
    AVG_Temp_egg_Hour ~ PFOS * Species + AVG_turns_hour,
    data = d
  )
  coef(fit)["PFOS"]   # Eider slope
}

set.seed(123)
boot_eider <- boot(
  data = combined_data,
  statistic = boot_fun_eider,
  R = 5000
)

# Bootstrap CI
boot.ci(boot_eider, type = "perc")
boot.ci(boot_eider, type = "bca")


#PLOT 4)
plot_data <- data.frame(slope = boot_vals)

ggplot(plot_data, aes(x = slope)) +
  geom_histogram(binwidth = 0.05, fill = "white", color = "black", alpha = 0.7) +
  geom_vline(xintercept = orig_val, color = "red", linewidth = 1.2) +
  geom_vline(xintercept = ci_eider, color = "green", linetype = "dashed", linewidth = 1) +
  labs(
    x = expression("Bootstrap PFOS slope (°C " * h^{-1} * ")"),
    y = "Frequency"
  ) +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA)
  )



#
#### 8) Additional plots #### 
#From the raw data. Individual example
#Cumpative hourly turns as a function of euler angle change in an individual
library(circular)
library(lubridate)
library(tidyverse)

GD1$Overal_angularChange_mean <- as.numeric(GD1$Overal_angularChange_mean)

#1)
#Euler angle based on Euler theorom
GDEX <- `GD11(K07)`

GDEX <- GDEX %>%
  mutate(FemaleID = "HT107525")

GDEX <- GDEX %>%
  mutate(AVG_turns_hour = 1.306)

GDEX <- GDEX %>%
  mutate(`Overall mean angular change` = 17.021)

GDEX <- GDEX %>%
  mutate(Euler_Angle = circular(sqrt(Roll^2 + Pitch^2 + Yaw^2), units="degrees")) 

GDSUM1 <- GDEX %>%
  group_by(FemaleID) %>%
  arrange(FemaleID) %>%
  mutate(
    cum_turns = cumsum(AVG_turns_hour),
    cum_angular_change = cumsum(`Overall mean angular change`)
  )


ggplot(GDSUM1, aes(x = cum_angular_change, y = cum_turns, color = as.factor(FemaleID))) +
  geom_line(size = 1, alpha = 0.6) + 
  geom_point() +  
  geom_smooth(method = "loess", aes(group = 1), color = "black", se = TRUE) + 
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    legend.position = c(0.96, 0.32),
    axis.line = element_line(color = "black"),
    plot.background = element_rect(fill = "transparent", colour = NA)) +
  labs(
    title = "",
    x = "Cumulative Angular Change (degrees)",
    y = "Cumulative Egg Turns (per hour)",
    color = "FemaleID"
  )



##Trnaslation of the code from Matlab
install.packages("R.matlab")
library(R.matlab)
#5 example eider females 
dAngle1<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dAngle1.mat")
dataSave1<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dataSave1.mat")
deltaAngle1<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\deltaAngle1.mat")
time1<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\time1.mat")
startInd1<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\startInd1.mat")
endInd1<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\endInd1.mat")
#
dAngle2<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dAngle2.mat")
dataSave2<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dataSave2.mat")
deltaAngle2<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\deltaAngle2.mat")
time2<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\time2.mat")
startInd2<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\startInd2.mat")
endInd2<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\endInd2.mat")
# 
dAngle3<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dAngle3.mat")
dataSave3<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dataSave3.mat")
deltaAngle3<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\deltaAngle3.mat")
time3<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\time3.mat")
startInd3<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\startInd3.mat")
endInd3<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\endInd3.mat")
#
dAngle4<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dAngle4.mat")
dataSave4<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dataSave4.mat")
deltaAngle4<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\deltaAngle4.mat")
time4<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\time4.mat")
startInd4<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\startInd4.mat")
endInd4<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\endInd4.mat")
#
dAngle5<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dAngle5.mat")
dataSave5<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\dataSave5.mat")
deltaAngle5<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\deltaAngle5.mat")
time5<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\time5.mat")
startInd5<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\startInd5.mat")
endInd5<- readMat("C:\\Users\\svasha\\Desktop\\Sajjad_Vakili\\Articles\\Artifical eggs comparison and thyroid\\endInd5.mat")

#2)
#dAngle <- dAngle1$dAngle
#dataSave <- dataSave1$dataSave
#deltaAngle <- deltaAngle1$deltaAngle
#time <- time1$time
#startInd <- startInd1$startInd
#endInd <- endInd1$endInd
individuals_data <- list(
  list(dAngle = dAngle1$dAngle, dataSave=dataSave1$dataSave, deltaAngle = deltaAngle1$deltaAngle, time = time1$time, startInd = startInd1$startInd, endInd = endInd1$endInd),
  list(dAngle = dAngle2$dAngle, dataSave=dataSave2$dataSave, deltaAngle = deltaAngle2$deltaAngle, time = time2$time, startInd = startInd2$startInd, endInd = endInd2$endInd),
  list(dAngle = dAngle3$dAngle, dataSave=dataSave3$dataSave, deltaAngle = deltaAngle3$deltaAngle, time = time3$time, startInd = startInd3$startInd, endInd = endInd3$endInd),
list(dAngle = dAngle4$dAngle, dataSave=dataSave4$dataSave, deltaAngle = deltaAngle4$deltaAngle, time = time4$time, startInd = startInd4$startInd, endInd = endInd4$endInd),
list(dAngle = dAngle5$dAngle, dataSave=dataSave5$dataSave, deltaAngle = deltaAngle5$deltaAngle, time = time5$time, startInd = startInd5$startInd, endInd = endInd5$endInd))
#3)

#threshold_deg <- 10
#threshold_rad <- threshold_deg * pi / 180

#indices_greater_than_threshold <- which(deltaAngle > threshold_rad)

#start_times <- time1[startInd[indices_greater_than_threshold]]
#end_times <- time1[endInd[indices_greater_than_threshold]]
all_num_events_per_hr <- list()
all_dAngle <- list()

#plot((dataSave[5, startInd] + dataSave[5, endInd]) / 2 / 3600, 
     #deltaAngle * 180 / pi, 
     #main = "Angle Change vs. Time", 
    # xlab = "Time [hr]", 
   #  ylab = "Change in Orientation [deg]", 
  #   pch = 20, 
 #    col = "blue")
#grid()

dAngle <- seq(0, 180, by = 1) * pi / 180
num_events_per_hr <- sapply(dAngle, function(angle) {
  3600 * sum(deltaAngle > angle) / (max(time) - min(time))
})

smooth_fit <- smooth.spline(dAngle * 180 / pi, num_events_per_hr, spar = 0.7)
#plot(dAngle * 180 / pi, num_events_per_hr, 
#   type = "l", 
#    col = "#B8800B", 
#   lwd=2,
#    main = "Rotations per Hour vs. Angular Threshold", 
#    xlab = "Angle Threshold [deg]", 
#   ylab = "Rotations per Hour", 
#   xaxp = c(0, 180, 9))

for (i in 1:length(individuals_data)) {
  # Access individual data
  individual <- individuals_data[[i]]
  
  deltaAngle <- individual$deltaAngle
  time <- individual$time
  startInd <- individual$startInd
  endInd <- individual$endInd
  
  # Calculate number of events per hour for this individual
  num_events_per_hr_individual <- sapply(dAngle, function(angle) {
    3600 * sum(deltaAngle > angle) / (max(time) - min(time))
  })
  
  # Store results
  all_num_events_per_hr[[i]] <- num_events_per_hr_individual
  all_dAngle[[i]] <- dAngle
}

combined_num_events_per_hr <- do.call(cbind, all_num_events_per_hr)
combined_dAngle <- all_dAngle[[1]]  # Assuming the same angles for all individuals

mean_num_events_per_hr <- apply(combined_num_events_per_hr, 1, mean)
sd_num_events_per_hr <- apply(combined_num_events_per_hr, 1, sd)
ci_lower <- mean_num_events_per_hr - 1.96 * (sd_num_events_per_hr / sqrt(ncol(combined_num_events_per_hr)))
ci_upper <- mean_num_events_per_hr + 1.96 * (sd_num_events_per_hr / sqrt(ncol(combined_num_events_per_hr)))


combined_dAngle_deg <- combined_dAngle * 180 / pi
x_value <- 10
y_value_at_x_10 <- approx(combined_dAngle_deg, mean_num_events_per_hr, xout = x_value)$y

y_lim <- range(c(mean_num_events_per_hr, ci_upper, ci_lower), na.rm = TRUE)

plot(combined_dAngle * 180 / pi, mean_num_events_per_hr, 
     type = "l", 
     col = "#B8800B", 
     lwd = 4,
     main = "", 
     xlab = "Anglular change [deg]", 
     ylab = "Cumulative turns per hour", 
     xaxp = c(0, 180, 9),
     bty="n",
     ylim=y_lim)

lines(combined_dAngle * 180 / pi, ci_upper, 
      col = "red", 
      lty = 2,  # Dashed line for upper CI
      lwd = 2)

lines(combined_dAngle * 180 / pi, ci_lower, 
      col = "red", 
      lty = 2,  # Dashed line for lower CI
      lwd = 2)

points(x_value, y_value_at_x_10, col = "black", pch = 20, cex = 1.5)


### Example of daily temperature 
#GD 1:
GDTem <- `GD11(K07)`

GDTem$Date <- as.Date(GDTem$Date)  
GDTem$Time <- as.POSIXct(paste(GDTem$Date, GDTem$Time), format="%Y-%m-%d %H:%M:%S") 
#Selecting a random date 
#random_date <- sample(unique(GDTem$Date), 1)
#print(random_date)
random_date<- as.Date("2022-05-15")
print(random_date)

GD_24h <- GDTem %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))

ggplot(GD_24h, aes(x = Time, y = Temp.egg.)) +
  geom_smooth(method = "loess", span=0.1, color = "#B8800B", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)) +
  labs(
    title = paste("Date:", random_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )

#GD 2: 
GDTem <- `GD81(K05)`

GDTem$Date <- as.Date(GDTem$Date)  
GDTem$Time <- as.POSIXct(paste(GDTem$Date, GDTem$Time), format="%Y-%m-%d %H:%M:%S") 

selected_date <- as.Date("2022-05-15")
print(selected_date)

GD_24h <- GDTem %>%
  filter(Time >= as.POSIXct(paste(selected_date, "00:00:00")) & 
           Time < as.POSIXct(paste(selected_date + 1, "00:00:00")))

ggplot(GD_24h, aes(x = Time, y = Temp.egg.)) +
  geom_smooth(method = "loess", span = 0.1, color = "#B8800B", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title = paste("Date:", selected_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )

#GD 3: 
GDTem <- `GD219(K16)`

GDTem$Date <- as.Date(GDTem$Date)  
GDTem$Time <- as.POSIXct(paste(GDTem$Date, GDTem$Time), format="%Y-%m-%d %H:%M:%S") 

selected_date <- as.Date("2022-05-15")
print(selected_date)

GD_24h <- GDTem %>%
  filter(Time >= as.POSIXct(paste(selected_date, "00:00:00")) & 
           Time < as.POSIXct(paste(selected_date + 1, "00:00:00")))

ggplot(GD_24h, aes(x = Time, y = Temp.egg.)) +
  geom_smooth(method = "loess", span = 0.1, color = "#B8800B", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title = paste("Date:", selected_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )

#GD 4: 
GDTem <- `GD96(K08)`

GDTem$Date <- as.Date(GDTem$Date)  
GDTem$Time <- as.POSIXct(paste(GDTem$Date, GDTem$Time), format="%Y-%m-%d %H:%M:%S") 

selected_date <- as.Date("2022-05-15")
print(selected_date)

GD_24h <- GDTem %>%
  filter(Time >= as.POSIXct(paste(selected_date, "00:00:00")) & 
           Time < as.POSIXct(paste(selected_date + 1, "00:00:00")))

ggplot(GD_24h, aes(x = Time, y = Temp.egg.)) +
  geom_smooth(method = "loess", span = 0.1, color = "#B8800B", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title = paste("Date:", selected_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )


### Eiders###
#ED 1:
EDTem <- `ED(B108W1.4)`

EDTem$Date <- as.Date(EDTem$Date)  
EDTem$Time <- as.POSIXct(paste(EDTem$Date, EDTem$Time), format="%Y-%m-%d %H:%M:%S") 
#Selecting a random date 
#Either an assigned date
random_date <- as.Date("2023-05-29")
print(random_date)
#OR a random date
#random_date <- sample(unique(EDTem$Date), 1)
#print(random_date)

ED_24h <- EDTem %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))

ggplot(ED_24h, aes(x = Time, y = Temp)) +
  geom_smooth(method = "loess", span=0.1, color = "blue", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)) +
  labs(
    title = paste("(Late breeder), Date:", random_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )

#ED 2: 
EDTem <- `ED(B102W2.4)`

EDTem$Date <- as.Date(EDTem$Date)  
EDTem$Time <- as.POSIXct(paste(EDTem$Date, EDTem$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-29")
print(random_date)

ED_24h <- EDTem %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))

ggplot(ED_24h, aes(x = Time, y = Temp)) +
  geom_smooth(method = "loess", span = 0.1, color = "blue", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title = paste("(Late breeder), Date:", random_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )
#ED3
EDTem <- `ED(B22W1.3)`

EDTem$Date <- as.Date(EDTem$Date)  
EDTem$Time <- as.POSIXct(paste(EDTem$Date, EDTem$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-15")
print(random_date)

#random_date <- sample(unique(EDTem$Date), 1)
#print(random_date)

ED_24h <- EDTem %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))

ggplot(ED_24h, aes(x = Time, y = Temp.egg.)) +
  geom_smooth(method = "loess", span = 0.1, color = "blue", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title = paste("(Early breeder), Date:", random_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )

#ED4

EDTem <- `ED(B23W2.3)`

EDTem$Date <- as.Date(EDTem$Date)  
EDTem$Time <- as.POSIXct(paste(EDTem$Date, EDTem$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-15")
print(random_date)


ED_24h <- EDTem %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))

ggplot(ED_24h, aes(x = Time, y = Temp)) +
  geom_smooth(method = "loess", span = 0.1, color = "blue", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title = paste("(Early breeder), Date:", random_date),
    x = "Time",
    y = "Egg Temperature (°C)"
  )

##### Daily turning movement 
library(circular)
library(lubridate)
library(tidyverse)
#Euler angle 
# Eider 1
EDMove1 <- `ED(B23W2.3)`

EDMove1$Date <- as.Date(EDMove1$Date)  
EDMove1$Time <- as.POSIXct(paste(EDMove1$Date, EDMove1$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-15")
print(random_date)

ED_24h <- EDMove1 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(ED_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "blue", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
ED_24h_long <- ED_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(ED_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable"
  )

# OR
ggplot(ED_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_line(size = 1, alpha = 0.7) +  # Reduce opacity for better readability
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  )+
  labs(
    title = paste("(Early breeder) - Roll, Yaw, and Pitch, Date:", random_date),
    x = "Time",
    y = "Euler Angles (degrees)",
    color = "Variable"
  )

# Eider 2
EDMove2 <- `ED(B22W1.3)`

EDMove2$Date <- as.Date(EDMove2$Date)  
EDMove2$Time <- as.POSIXct(paste(EDMove2$Date, EDMove2$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-15")
print(random_date)

ED_24h <- EDMove2 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(ED_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "blue", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
ED_24h_long <- ED_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(ED_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

# Eider 3
EDMove3<- `ED(B102W2.4)`

EDMove3$Date <- as.Date(EDMove3$Date)  
EDMove3$Time <- as.POSIXct(paste(EDMove3$Date, EDMove3$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-29")
print(random_date)

ED_24h <- EDMove3 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(ED_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "blue", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
ED_24h_long <- ED_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(ED_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

# Eider 4
EDMove4<- `ED(B108W1.4)`

EDMove4$Date <- as.Date(EDMove4$Date)  
EDMove4$Time <- as.POSIXct(paste(EDMove4$Date, EDMove4$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2023-05-29")
print(random_date)

ED_24h <- EDMove4 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(ED_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "blue", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
ED_24h_long <- ED_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(ED_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

###In goldeneye
#GD1
GDMove1 <- `GD11(K07)`

GDMove1$Date <- as.Date(GDMove1$Date)  
GDMove1$Time <- as.POSIXct(paste(GDMove1$Date, GDMove1$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2022-05-15")
print(random_date)

GD_24h <- GDMove1 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(GD_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "#B8800B", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
GD_24h_long <- GD_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(GD_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

# GD2
GDMove2 <- `GD81(K05)`

GDMove2$Date <- as.Date(GDMove2$Date)  
GDMove2$Time <- as.POSIXct(paste(GDMove2$Date, GDMove2$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2022-05-15")
print(random_date)

GD_24h <- GDMove2 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(GD_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "#B8800B", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
GD_24h_long <- GD_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(GD_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

# GD3
GDMove3 <- `GD219(K16)`

GDMove3$Date <- as.Date(GDMove3$Date)  
GDMove3$Time <- as.POSIXct(paste(GDMove3$Date, GDMove3$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2022-05-15")
print(random_date)

GD_24h <- GDMove3 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(GD_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "#B8800B", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
GD_24h_long <- GD_24h %>%
  select(Time, Roll, Yaw, Pitch) %>%
  pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")

# 
ggplot(GD_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

# GD4
GDMove4 <- `GD96(K08)`

GDMove4$Date <- as.Date(GDMove4$Date)  
GDMove4$Time <- as.POSIXct(paste(GDMove4$Date, GDMove4$Time), format="%Y-%m-%d %H:%M:%S") 

random_date <- as.Date("2022-05-15")
print(random_date)

GD_24h <- GDMove4 %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))
##Euler angle (It has problem with smoothing. So I just use line plot)
ggplot(GD_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "#B8800B", alpha=0.8) + 
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +  # Instead of geom_smooth
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title="",
    x = "Time",
    y = "Euler angle change"
  )
#
#Roll, Pitch, Yaw
# Convert dataset to long format
library(dplyr)
library(tidyr)

GD_24h_long <- GD_24h %>%
  dplyr::select(Time, Roll, Yaw, Pitch) %>%
  tidyr::pivot_longer(cols = c(Roll, Yaw, Pitch), names_to = "Variable", values_to = "Value")


# 
ggplot(GD_24h_long, aes(x = Time, y = Value, color = Variable)) +
  geom_smooth(method = "loess", span = 0.2, size=1,alpha=0.8, se = FALSE) +  # Smooth curves
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  scale_y_continuous(limits=c(-180,180), breaks=seq(-180,180,by=45))+
  theme(
    panel.background = element_rect(fill = "transparent", colour = NA),
    axis.line = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.background = element_rect(fill = "transparent", colour = NA)
  ) +
  labs(
    title ="",
    x = "Time",
    y = "Turning attitudes (degrees)",
    color = "Variable")

####### Euler+Temp plot#####
#GD4
library(patchwork)

GDData <- `GD11(K07)`
# Convert Date and Time
GDData$Date <- as.Date(GDData$Date)  
GDData$Time <- as.POSIXct(paste(GDData$Date, GDData$Time), format="%Y-%m-%d %H:%M:%S")

# Select Date
selected_date <- as.Date("2022-05-15")
#start_date <- as.Date("2022-05-15 00:00:00")
#end_date <- as.Date("2022-05-19 00:00:00")
#GD_MultiDay <- GDData %>%
 # filter(Date >= start_date & Date <= end_date)
# Filter Data for 24 hours
GD_24h <- GDData %>%
  filter(Time >= as.POSIXct(paste(selected_date, "00:00:00")) & 
           Time < as.POSIXct(paste(selected_date + 1, "00:00:00")))

# First Plot: Egg Temperature
p1 <- ggplot(GD_24h, aes(x = Time, y = Temp.egg.)) +
  geom_smooth(method = "loess", span = 0.1, color = "#B8800B", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  labs(
    title = "",
    y = "Temperature (°C)",
    x = ""
  ) +
  #coord_cartesian(ylim = c(NA, 43)) + 
  scale_y_continuous(
    limits = c(35, 43),
    expand = c(0, 0),
    breaks = seq(35, 42.5, by = 2.5))+
  theme_minimal()+
  theme(
    axis.text.x = element_blank(),   # remove x-axis text
    axis.ticks.x = element_blank(),  # remove x-axis ticks
    axis.title.x = element_blank()   # remove x-axis label
  )
#theme(
 # panel.background = element_rect(fill = "transparent", colour = NA),
  #axis.line = element_line(color = "black"),
  #axis.text.x = element_text(angle = 45, hjust = 1),
  #plot.background = element_rect(fill = "transparent", colour = NA)
#)

# Second Plot: Euler Angle (On its Own Scale)
p2 <- ggplot(GD_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "#B8800B", alpha = 0.8, linewidth = 1) +
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  labs(
    title = "",
    y = "Angular change (°)",
    x = "Time"
  ) +
  theme_minimal()+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    axis.title.x = element_blank()
  )

# Combine the two plots with the same X-axis
p1 / p2  # Using `patchwork` to stack them vertically

## ED4

EDdata <- `ED(B108W1.4)`

EDdata$Date <- as.Date(EDdata$Date)  
EDdata$Time <- as.POSIXct(paste(EDdata$Date, EDdata$Time), format="%Y-%m-%d %H:%M:%S") 
#Selecting a random date 
#Either an assigned date
#selected_date <- as.Date("2023-05-29")
#print(selected_date)
#OR a random date
random_date <- sample(unique(EDdata$Date), 1)
print(random_date)
#or
#random_date<- as.Date("2023-06-02")

ED_24h <- EDdata %>%
  filter(Time >= as.POSIXct(paste(random_date, "00:00:00")) & 
           Time < as.POSIXct(paste(random_date + 1, "00:00:00")))

p1 <- ggplot(ED_24h, aes(x = Time, y = Temp)) +
  geom_smooth(method = "loess", span = 0.1, color = "cornflowerblue", se = FALSE) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  labs(
    title = "",
    y = "Temperature (°C)",
    x = ""
  ) +
  scale_y_continuous(
    limits = c(35, 42.5),
    expand = c(0, 0),
    breaks = seq(35, 42.5, by = 2.5))+
  theme_minimal()+
  theme(
    axis.text.x = element_blank(),   # remove x-axis text
    axis.ticks.x = element_blank(),  # remove x-axis ticks
    axis.title.x = element_blank()   # remove x-axis label
  )
#theme(
# panel.background = element_rect(fill = "transparent", colour = NA),
#axis.line = element_line(color = "black"),
#axis.text.x = element_text(angle = 45, hjust = 1),
#plot.background = element_rect(fill = "transparent", colour = NA)
#)

# Second Plot: Euler Angle (On its Own Scale)
p2 <- ggplot(ED_24h, aes(x = Time, y = Euler_angle)) +
  geom_line(color = "cornflowerblue", alpha = 0.8, size = 1) +
  geom_hline(yintercept = 10, color = "red", linetype = "dashed", size = 1) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hours") +
  labs(
    title = "",
    y = "Angular change (°)",
    x = "Time"
  ) +
  coord_cartesian(ylim = c(0, 50)) + 
  theme_minimal()+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
    axis.title.x = element_blank()
  )

# Combine the two plots with the same X-axis
p1 / p2  # Using `patchwork` to stack them vertically

###Credits:  Farshad.S.Vakili; Farshad.s.vakili@gmail.com



